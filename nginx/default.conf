# ============================================================
# LLM Enterprise Platform - Nginx Gateway
# ============================================================
# Punto de entrada unico para todos los servicios del curso.
# Todas las rutas estan bajo /curso/
# ============================================================

upstream api {
    server api:8000;
}

upstream vllm {
    server vllm:8000;
}

upstream ollama {
    server ollama:11434;
}

upstream qdrant {
    server qdrant:6333;
}

upstream langfuse {
    server langfuse-web:3000;
}

server {
    listen 80;
    server_name localhost;

    # --- Timeouts generosos para inferencia LLM ---
    proxy_connect_timeout 300s;
    proxy_send_timeout    300s;
    proxy_read_timeout    300s;
    send_timeout          300s;

    # --- Headers comunes ---
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # === FastAPI (API Base) ===
    location /curso/api/ {
        proxy_pass http://api/;
    }

    # === vLLM (Inference - stack base) ===
    location /curso/vllm/ {
        proxy_pass http://vllm/;
        proxy_buffering off;
    }

    # === Ollama (Inference - perfil ollama) ===
    # Reescribe /curso/ollama/* -> /v1/* para exponer solo la API OpenAI-compatible
    location /curso/ollama/ {
        rewrite ^/curso/ollama/(.*) /v1/$1 break;
        proxy_pass http://ollama;
        proxy_buffering off;
    }

    # === Qdrant (Vector DB) ===
    location /curso/qdrant/ {
        proxy_pass http://qdrant/;
    }

    # === Langfuse (Observability) ===
    location /curso/langfuse/ {
        proxy_pass http://langfuse/;
        # WebSocket support para Langfuse UI
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # === Root: redirigir a /curso/api/docs ===
    location = / {
        return 302 /curso/api/docs;
    }

    location = /curso/ {
        return 302 /curso/api/docs;
    }
}
